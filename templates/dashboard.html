<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WoL Command Center</title>

    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: { colors: { slate: { 850: '#151b2e', 900: '#0f172a' } } } }
        }
    </script>
    <style>
        @keyframes ping-slow {

            75%,
            100% {
                transform: scale(2);
                opacity: 0;
            }
        }

        .animate-ping-slow {
            animation: ping-slow 2s cubic-bezier(0, 0, 0.2, 1) infinite;
        }

        /* Modal Backdrop Blur */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }
    </style>
</head>

<body class="bg-slate-900 text-slate-200 min-h-screen p-6 font-sans">

    <div id="root" class="max-w-7xl mx-auto"></div>

    {% raw %}
    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- Icons ---
        const PowerIcon = () => <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={2} stroke="currentColor" className="w-5 h-5"><path strokeLinecap="round" strokeLinejoin="round" d="M5.636 5.636a9 9 0 1012.728 0M12 3v9" /></svg>;
        const TrashIcon = () => <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-4 h-4"><path strokeLinecap="round" strokeLinejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" /></svg>;
        const PencilIcon = () => <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-4 h-4"><path strokeLinecap="round" strokeLinejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L6.832 19.82a4.5 4.5 0 01-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 011.13-1.897L16.863 4.487zm0 0L19.5 7.125" /></svg>;

        function App() {
            const [machines, setMachines] = useState([]);

            // Edit / Add State
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingId, setEditingId] = useState(null); // null = adding mode
            const [formData, setFormData] = useState({ name: "", ip: "", mac: "", user: "" });

            useEffect(() => {
                fetchMachines();
                const interval = setInterval(fetchMachines, 3000);
                return () => clearInterval(interval);
            }, []);

            const fetchMachines = async () => {
                try {
                    const res = await axios.get('/api/machines');
                    // Only update if not currently editing (to prevent inputs jumping)
                    if (!isModalOpen) setMachines(res.data);
                } catch (err) { console.error(err); }
            };

            const sendWake = async (mac, name, currentStatus) => {
                // Debugging: Check your browser console to see what is being passed
                console.log(`Click detected for ${name}. Status received:`, currentStatus);

                // GUARD CLAUSE:
                // If status is 'online' OR if status was not passed correctly (undefined), stop here.
                if (currentStatus === 'online' || !currentStatus) {
                    return;
                }

                try {
                    await axios.post('/api/wake', { mac });
                    alert(`⚡ Signal sent to ${name}`);
                } catch (err) {
                    alert("Failed to send packet");
                }
            };

            const handleDelete = async (id) => {
                if (!confirm("Are you sure you want to delete this machine?")) return;
                await axios.delete(`/api/delete/${id}`);
                fetchMachines();
            };

            const openAddModal = () => {
                setEditingId(null);
                setFormData({ name: "", ip: "", mac: "", user: "" });
                setIsModalOpen(true);
            };

            const openEditModal = (m) => {
                setEditingId(m.id);
                setFormData({ name: m.name, ip: m.ip, mac: m.mac, user: m.user });
                setIsModalOpen(true);
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (editingId) {
                    await axios.put(`/api/update/${editingId}`, formData);
                } else {
                    await axios.post('/api/add', formData);
                }
                setIsModalOpen(false);
                fetchMachines();
            };

            return (
                <div className="pb-20">
                    <div className="flex items-center justify-between mb-8 sticky top-0 bg-slate-900/90 backdrop-blur-md py-4 z-10 border-b border-slate-800">
                        <div>
                            <h1 className="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-emerald-400">
                                WoL Dashboard
                            </h1>
                        </div>
                        <button onClick={openAddModal} className="bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-2 rounded-lg font-medium transition-colors shadow-lg shadow-emerald-900/20 text-sm">
                            + Add Machine
                        </button>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                        {machines.map(m => (
                            <div key={m.id} className={`
                                relative p-5 rounded-xl border transition-all duration-300 group
                                ${m.status === 'online'
                                    ? 'bg-slate-850 border-emerald-500/30 shadow-[0_0_15px_rgba(16,185,129,0.05)]'
                                    : 'bg-slate-850 border-slate-700/50 opacity-90'}
                            `}>
                                {/* Header: Name & Status */}
                                <div className="flex justify-between items-start mb-4">
                                    <div>
                                        <h3 className="text-lg font-bold text-slate-100">{m.name}</h3>
                                        <p className="text-xs text-slate-400 font-mono">{m.ip}</p>
                                    </div>
                                    <div className="flex flex-col items-end gap-1">
                                        <div className="flex h-3 w-3 relative">
                                            {m.status === 'online' && <span className="animate-ping-slow absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>}
                                            <span className={`relative inline-flex rounded-full h-3 w-3 ${m.status === 'online' ? 'bg-emerald-500' : 'bg-rose-500'}`}></span>
                                        </div>
                                        <span className={`text-[10px] font-bold uppercase tracking-wider ${m.status === 'online' ? 'text-emerald-500' : 'text-rose-500'}`}>{m.status}</span>
                                    </div>
                                </div>

                                {/* Details */}
                                <div className="space-y-2 mb-6 bg-slate-900/50 p-3 rounded-lg border border-slate-800/50">
                                    <div className="flex justify-between text-sm">
                                        <span className="text-slate-500">User</span>
                                        <span className="text-slate-300 font-medium">{m.user || "—"}</span>
                                    </div>
                                    <div className="flex justify-between text-sm">
                                        <span className="text-slate-500">MAC</span>
                                        <span className="text-slate-400 font-mono text-xs">{m.mac}</span>
                                    </div>
                                </div>

                                {/* Actions */}
                                <div className="flex gap-2">
                                    <button
                                        /* CRITICAL FIX: You must pass 'm.status' as the 3rd item here */
                                        onClick={() => sendWake(m.mac, m.name, m.status)}

                                        /* Visual Disable */
                                        disabled={m.status === 'online'}

                                        className={`
                                            w-full py-2.5 rounded-xl font-medium text-sm flex items-center justify-center gap-2 transition-all
                                            ${m.status === 'online'
                                                ? 'bg-slate-800 text-slate-500 cursor-not-allowed opacity-50'
                                                : 'bg-blue-600 hover:bg-blue-500 text-white shadow-lg shadow-blue-900/20 active:scale-95 cursor-pointer'}
                                        `}
                                    >
                                        <PowerIcon />
                                        {m.status === 'online' ? 'System Online' : 'Wake Up'}
                                    </button>
                                    <button onClick={() => openEditModal(m)} className="p-2 rounded-lg bg-slate-800 hover:bg-slate-700 text-slate-400 hover:text-blue-400 border border-slate-700 transition-colors">
                                        <PencilIcon />
                                    </button>
                                    <button onClick={() => handleDelete(m.id)} className="p-2 rounded-lg bg-slate-800 hover:bg-rose-900/30 text-slate-400 hover:text-rose-400 border border-slate-700 transition-colors">
                                        <TrashIcon />
                                    </button>
                                </div>
                            </div>
                        ))}
                    </div>

                    {/* Modal */}
                    {isModalOpen && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop">
                            <div className="bg-slate-800 rounded-2xl shadow-2xl w-full max-w-md border border-slate-700 p-6 animate-[fadeIn_0.2s_ease-out]">
                                <h2 className="text-xl font-bold mb-4">{editingId ? 'Edit Machine' : 'Add Machine'}</h2>
                                <form onSubmit={handleSubmit} className="space-y-4">
                                    <div>
                                        <label className="block text-xs font-semibold text-slate-400 uppercase mb-1">Hostname</label>
                                        <input required className="w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 focus:border-blue-500 focus:outline-none" value={formData.name} onChange={e => setFormData({ ...formData, name: e.target.value })} />
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-xs font-semibold text-slate-400 uppercase mb-1">IP Address</label>
                                            <input required className="w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 focus:border-blue-500 focus:outline-none" value={formData.ip} onChange={e => setFormData({ ...formData, ip: e.target.value })} />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-semibold text-slate-400 uppercase mb-1">User</label>
                                            <input className="w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 focus:border-blue-500 focus:outline-none" value={formData.user} onChange={e => setFormData({ ...formData, user: e.target.value })} />
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-xs font-semibold text-slate-400 uppercase mb-1">MAC Address</label>
                                        <input required className="w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 focus:border-blue-500 focus:outline-none font-mono" value={formData.mac} onChange={e => setFormData({ ...formData, mac: e.target.value })} />
                                    </div>
                                    <div className="flex gap-3 mt-6 pt-4 border-t border-slate-700">
                                        <button type="button" onClick={() => setIsModalOpen(false)} className="flex-1 px-4 py-2 rounded-lg bg-slate-700 hover:bg-slate-600 text-slate-300">Cancel</button>
                                        <button type="submit" className="flex-1 px-4 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-500 text-white font-medium">Save</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
    {% endraw %}
</body>

</html>